>[!info] Einleitung
>Industrielle Anlagen werden dauerhaft mittels Fernwartungsterminals (Remote Terminal Unit: RTU) sowie speicherprogrammierbare Steuerungen (Programmable Logic Controllers: PLC). Zur Verwaltung dieser wird ein Supervisory Control and Data Acquisition-System(SCADA). SCADA-Systeme ermöglichen damit einen übergreifenden Zugriff auf die gesamte industrielle Steuerungslandschaft.

 >[!tip] Kommunikationsprotokolle Siemens 
 Bei den speicherprogrammierbaren Steuerungen (PLC) von Siemens dominieren die Protokolle S7 Communication (S7comm) und S7 Communication Plus (S7comm-plus). Die S7-Protokolle sind historisch aus dem OSI-Protokoll-Stack hervorgegangen und nicht aus dem flexibleren TCP/IP- Stack („rivalisierende“ Netzwerkarchitekturen). Übertragen werden sie über das Connection Oriented Transport Protocol (COTP), das funktional eine ähnliche Rolle wie TCP übernimmt. Damit die Protokolle dennoch in die TCP/IP-Welt integriert werden können, fungiert TPKT (ISO transport services on top of TCP; Transport Packet) als Schnittstelle zwischen den beiden Stacks
 >	![[Pasted image 20251006135359.png]]
 >
 Feld Protokoll-ID: **0x32 steht für S7comm**, während **0x72 für S7comm-plus** verwendet wird.
 >Weitere Relevante Felder:
 >	![[Pasted image 20251006135726.png]]
 
 >[!info] Übungsnetzwerk (Aufbau)
 >Sie befinden sich in einem Atomkraftwerk, in dem zwei PLCs die Kühlwasserpumpen steuern. Ein SCADA-Arbeitsplatz stellt dazu zwei Schaltflächen bereit: zum Aktivieren/Deaktivieren der Pumpen sowie für eine Notabschaltung. Ergänzend gibt es einen Techniker-Arbeitsplatz für Wartung und Programmierung der PLCs. Das Netzwerk selbst ist als isolierte Umgebung konzipiert und besitzt keine direkte Verbindung nach außen.
 >
 >![[Pasted image 20251006140013.png]]
 
>[!abstract] Wireshark
>Erlaubt eine Untersuchung von Datenpaketen und bietet ebenfalls eine cmd-Variante tshark.
>Zur Eingrenzung von Daten gibt es zwei filter typen: Capture Filter für die Aufzeichnung und flexible Display Filter.
>
>Übersicht wichtiger Anzeige Filter:
>![[Pasted image 20251006140732.png]]
>
>tshark:
>![[Pasted image 20251006170518.png]]
>
>Für normal.pcapng:
>![[Pasted image 20251006180500.png]]
>
>Verhalten ableiten -> S7-Protokoll:
>![[Pasted image 20251006190542.png]]
>
>Für normal und buttonPush.pcapng:
>![[Pasted image 20251006190656.png]]
>
>>[!bug] Display-Filter (Vervollständigen)
>>Display-Filter | Information 
>>:-- | --:
>>eth.src | Quell-MAC
>>eth.dst | Ziel-MAC
>>eth-addr | Quell- oder Ziel-MAC
>>tcp.analysis.retransmission | erneut gesendete Pakete
>>arp.opcode == 1 | arp request
>>arp-opcode == 2 | arp reply
>>

## 1 Regulärer Datenverkehr als Ausgangslage
>[!info] Hintergrundinfo:
>- Der SCADA-Arbeitsplatz ist ausschließlich für die Steuerung der PLCs zuständig.
>- Der Techniker-Arbeitsplatz wartet den Programmcode der PLCs und die zugehörige Anwendung auf dem SCADA-Arbeitsplatz über VNC (TCP-Port 5900).
>
>>[!success] Verbindungen:
>>```mermaid
>>graph TD
>>DellOptiPlex_PC1CYBLAB --> MAC:f4:8e:38:9f7c:74 --> IP:10.3.5.3
>>Siemens_ad_Pumpe --> 28:63:36:ad:91:96 --> 10.3.5.12
>>Siemens_Techniker --> 00:1b:1b:f7:7c:4f --> 10.3.5.5
>>Siemens_ae_Pumpe --> 28:63:36:ae:70:09 --> 10.3.5.11
>>```

>[!success] Lösung:
>![[Pasted image 20251006191948.png]]

## 2 Mehrstufige Angriffserkennung 
>[!abstract] Verdächtiges Verhalten
>Auf Grundlage der im ersten Teil erarbeiteten Baseline sollen Sie nun abweichendes Verhalten im Netzwerk erkennen. Im SCADA-Netzwerk wurden erste Unregelmäßigkeiten festgestellt, nachdem ein Mitarbeiter ein Word-Dokument mit eingebetteten Makros geöffnet hat. Ihnen stehen weitere Netzwerkmitschnitte zur Verfügung, die die Aktivitäten einer Malware im Netzwerk dokumentieren. Vergleichen Sie die statistischen und beobachteten Werte der regulären Netzwerkauslastung – Ihre etablierte Baseline aus dem vorherigen Praktikum – mit den Mitschnitten, in denen Angriffe simuliert wurden. Die Untersuchung erfolgt in mehreren aufeinanderfolgenden Angriffsphasen, die jeweils steigende Aufmerksamkeit und Analyseintensität erfordern. Für jede Phase sollen Sie systematisch Abweichungen zum Ausgangszustand erfassen. 
>
>>[!danger] Phase 1: Initialer Einbruch - Kontaktaufnahme für einen Online Modus
>>![[Pasted image 20251008112833.png]]
>>
>>- Timestamp: Jun 8, 2018 13:46:47
>>- Frame Number: 96
>>
>>Beobachtung: 
>>Abnormales Verhalten des Technikerarbeitsplatzes 10.3.5.5. Dieser schickt UDP-Pakete an 234.5.6.7 über Port: src:60070  -> dst:8910
>>
>>Desweiteren zusehen Erfolglose TCP-Handshakes -> [SYN]
>>![[Pasted image 20251008114507.png]]
>
>>[!danger] Phase 2: Lateral Movement - Offline-Modus (Seitwärtsbewegung)
>>- Typische Angriffe treffen heute meist nicht direkt kritische Systeme. Häufig werden zunächst weniger sichere Systeme kompromittiert, von denen aus interne Vertrauensbeziehungen im Netzwerk ausgenutzt werden, um sich lateral (von einem System zum Nächsten) zu bewegen.
>>
>>- Problematisch für die Malware ist zudem, dass sie keinen Kontakt zu ihrem vermeintlichen Command and Control-Server (C&C) aufnehmen kann. Ohne Steuerbefehle wechselt sie automatisch in einen Offline-Modus.
>>
>>Beobachtungen: 
>>Als erstes wird allen anschein nach von dem Techniker Arbeitsplatz aus eine große menge an arp Paketen versendet um die Umgebung abzuscannen. dann führt der Techniker arbeitsplatz einen Portscann auf die Siemens_ae und den DellOptiplex (SCADA) durch um offene port zufinden.
>>
>>IO-Graph: 
>>![[attack2.pdf]]
>>
>>**Um die offenen Ports zu Ermitteln** können wir von Display-Filtern gebrauch machen:
>>```bash
>>!(tcp.analysis.retransmission) && tcp.flags == 0x12
>>```
>>```bash
>>(tcp.flags.ack == 1 && tcp.flags.syn == 1)
>>```
>>![[Pasted image 20251008150928.png]]
>>
>>In diesem Bild sind auf Grund der [SYN, ACK] Flags von SCADA(10.3.5.3) die Offenen Ports am SCADA-System erkennbar: 
>>```
>>80(http), 135(RCP), 445(SMB), 3389(RDP), 5800(VNC), 5900(VNC)
>>```
>
>>[!danger] Phase 3: Da ist noch mehr - Kritische Systemziele bestimmen
>>- Warum führt die Malware diesen Schritt aus, und warum konnte sie diese Informationen im vorherigen Schritt nicht ermitteln? Denken Sie daran, in welcher Umgebung Sie sich befinden und was darin eventuell anders ist als in klassischen IT-Systemen.
>>	- Die beiden PLCs antworten auf den arp-request, haben allerdings keine offenen Ports beim scan gemeldet der Port 102 wurde vom Standartscan nicht mit erfasst. (attack2.pcapng)
>>	```bash
>>		tcp.flags.syn == 1 && tcp.port == 102
>>	```
>>- Wie hätte dieser Angriff besser getarnt werden können, um weniger auffällig zu sein?
>>	- Verwendung des korrekten Protokolls s7comm-plus anstatt von s7comm. Herantasten durch andere Ports, anstatt direkt einen S7-Scan(PLC-Scan) durchzuführen. Hinweis: der Scan ähnelt nmap:
>>	```bash
>>		nmap -Sn -sT -p 102 -script s7-info.nse host
>>	```
>>
>>Techniker 10.3.5.5 -> Siemens_ae 10.3.5.11
>>![[Pasted image 20251009191713.png]]
>>
>>Techniker 10.3.5.5 -> Siemens_ad 10.3.5.12
>>![[Pasted image 20251009191618.png]] 
>
>> [!danger] Phase 4: Rohe Gewalt
>>- VNC-Authentifizierung: Virtual Network Computing (VNC) nutzt eine Challenge-Response- Authentifizierung: Der Server sendet eine zufällige Sequenz von 16 Byte, die der Client mit einem vereinbarten Passwort als DES-verschlüsselte Antwort zurückschickt. Der Server liefert daraufhin eine Authentifizierungs-Antwort. Sind die ersten vier Byte dieser Antwort ausschließlich Nullen, war die Authentifizierung erfolgreich; andernfalls enthält die Antwort eine Fehlermeldung. Hinweis: Wireshark bereitet diese Pakete nicht vollständig auf. Prüfen Sie daher auch direkt den Hex-Code (Big Endian) des entsprechenden Felds in der Byteansicht des Pakets.
>>
>>Anschnitt erfolgreiche Authentifizierungs-Antwort: Paket 386 mit vier Byte Nullen.
>>![[Pasted image 20251009195921.png]]
>>
>>Mögliche Filter: 
>>```bash
>>vnc.auth_result oder direkter Bytevergleich vnc[0:4] == 00:00:00:00
>>```
>
>>[!danger] Phase 5: Feinarbeit
>>- Eine der Pumpen ist deaktiviert wurden und die Verantwortlichen Mitarbeiter haben nichts damit zutun
>>
>>VNC: Client Pointer Event:
>>![[Pasted image 20251010133246.png]]
>>- Paket 949 und 951 -> Mousclick Event gefolgt von Paket 952 -> 953 (Button)
>>- Zugriff von Techniker auf SCADA System zum auslösen der Ereignisse. 
>>
>>Unregelmäßigkeiten S7-Protokoll -> suche nach SetMultiVariables:
>>```bash
>>s7comm-plus.data.function == 0x0542
>>```
>>![[Pasted image 20251010133956.png]]
>
>>[!tip] Abschlussbetrachtung
>>- Nur die Arbeitsplätze sollten mit den PLCs kommunizieren
>>- Kommunikation sollte auf den TCP-Port 102 und das Protokoll s7comm-plus(Typ 0x72) bzw. VNC beschränkt werden
>>- Nur der Techniker sollte mit RTU über VNC kommunizieren
>>- Limitierung der Login-Versuche für VNC oder andere Lösung (nur Eindämmung)

### 3 Exkurs: Letzte Angriffsphase analysieren
>[!abstract]
>In der letzten Angriffsphase versucht die Malware, die PLCs neu zu programmieren. Sie liest dazu das aktuelle Programm einer PLC aus, modifiziert es und schreibt es anschließend zurück auf die PLC. Das neue Programm verändert den Systemablauf und verhindert damit das Reaktivieren der Pumpe über die originale Benutzerschnittstelle auf dem SCADA-Arbeitsplatz. Versuchen Sie, die Netzwerkaktivität
>
>>[!danger] Beobachtung
>>- Hohe Anzahl von TCP Paketen
>>![[Screenshot_IO-Graph 1.pdf]]