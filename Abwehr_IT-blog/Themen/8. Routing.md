### <mark style="background: #BBFABBA6;">Session Layer</mark> 
>[!info]
>### Network Basic Input/Output System NETBIOS
>- Beschreibt Routinen zur Netzwerkkommunikation z.B. zum Sitzungsaufbau und Datentransfer
>- Ermöglicht kein Routing > erst durch NetBIOS per TCP/IP
>
Ähnlich dem NetBIOS existiert für Workgroup Namensauflösungen das LLNMR
Protokoll.
Link Local Multicast Name Resolution (LLMNR) ist ein Protokoll basierend auf
dem DNS-Paketformat, das IPv4 und IPv6 Hosts die Namensauflösung für Hosts
im selben lokalen Netzwerk erlaubt.
Unter IPv4 arbeitet LLMNR parallel zum in NetBIOS integrierten Name Service
NBNS und ersetzt NBNS unter IPv6, da NetBIOS nicht IPv6 unterstützt.
>
Wer sich einen Überblick über LLMNR- und NBT-NS-Anfragen verschaffen
möchte, kann den lokalen Netzwerkverkehr mithilfe von Wireshark und des
folgenden Display-Filters prüfen:
>
NetBIOS Abfrage sind möglich über das Kommandozeilen Tool `nbtstat`:
>```bash
>nbtstat -A 172.16.0.1
>```
Als Antwort erhält man Informationen über:
![[Pasted image 20260128182439.png]]

>[!info]
>#### Server Message Block Protokoll SMB
>- SMB Sicherheitsmodell:
>	- Freigabeebene, Benutzername, Passwort
>
>#### Common Internet File System CIFS
Neuerungen gegenüber SMB:
>- SMB über TCP/IP Port: 445
>- DNS Namensauflösung
>- General Security Service Provider
>- Signieren von SMB Paketen
>- NTLMv2
>
>### LM und NTLM Challenge und Response Verfahren
>
![[Pasted image 20260128183147.png]]
>
![[Pasted image 20260128183804.png]]
>
![[Pasted image 20260128183842.png]]

>[!danger]
>### Angriffe aus NETBIOS MitM Attack 
>
>#### Run Finger
>Ziel: Umgehung der Auth. durch eine Responder-MultiRelay-Attacke auf NetBIOS als MitM Angreifer.
>Voraussetzungen:
>- Zugang zum lokalen Netzwerk (Netzwerkdose/WLAN)
>- Zielsystem ohne SMB Signing finden (RunFinger.py)
>- NetBIOS Anfrage von einem Client im lokalen Netzwerk (Warten)
>
![[Pasted image 20260128184254.png]]
>
>### Responder
Nutzung eines Responders für die Beantwortung von NetBIOS Anfragen:
Dieses Tool nutzt Broadcasts und Multicasts für Namensauflösungsanfragen im lokalen
Netzwerksegment aus, um immer mit der IP-Adresse des Angreifers zu antworten.
>
![[Pasted image 20260128184605.png]]
>
Nutzung eines Responders für die Beantwortung von NetBIOS Anfragen:
Computer im gleichen Netzwerksegment stellen Namensauflösungsanfragen
normalerweise über DNS-Lookups direkt an die DNS-Server. Diese sieht der Responder
nicht, jedoch NBNS oder LLMNR-Abfragen im Netzwerk.
>
![[Pasted image 20260128184720.png]]
>
Nutzung des Multirelay für die Aufzeichnung oder Weiterleitung der Hashes:
Hat es der Responder geschafft, einen Computer, der einen SMB-Server sucht auf seine
eigene IP-Adresse zu verweisen, dann kann er einen NTLM-Challenge aufzuzeichnen, um
diesen zu knacken.
Einfacher ist es, wenn man die Anmeldung im Netzwerk umlenkt. Damit authentifiziert sozusagen der gekaperte NetBIOS Rechner den Angreifer am Server selbst.
>
![[Pasted image 20260128184843.png]]
>
 >#### Amplification Attack
Die NetBIOS-Reflection-DDoS-Attacke - speziell die NetBIOS-Name-Service-Reflection
(NBNS) ist eine spezielle Variante einer DDoS Amplification Attacke. Obwohl legitime und
böswillige NBNS-Abfragen am UDP-Port 137 häufig vorkommen, kann eine Antwortflut
einen DDoS-Ausfall bei einem Opfer auslösen. Dazu muss der Angreifer nur genügend
Anfragen mit gespoofter Opfer IP versenden.
>
![[Pasted image 20260128190527.png]]
>
>#### Remote Procedure Call RPC 
Remote Procedure Call bedeutet auf Deutsch „Aufruf einer fernen Prozedur“ und
ist eine Programmierschnittstelle zur Interprozesskommunikation IPC mit
entfernten Rechnern oder dem lokalen System. Das RPC setzt auf dem UDP-
oder TCP-Protokoll auf.
Eine RPC-Kommunikation verläuft nach folgendem Prinzip:
>1. Client-Anwendung sendet eine RPC-Nachricht an den Server
>2. auf dem Server installierter Portmapper (Endpointmapper) empfängt, liest Daten und leitet die an Server-Anwendung
>3. Server-Anwendung verarbeitet den Auftrag und schickt Antwort an Client
>
>#### RPC Amplification Attack
Ein RPC-Portmapper-Reflection-DDoS-Angriff beginnt mit böswilligen Abfragen an das
Portmap-Programmprotokoll von RPC. Das Angriffstool steht auf vielen Betriebssystemen
zur Verfügung, und ähnelt dem rpcinfo-Tool und Spooft die Absenderadresse.
Das Tool rpcinfo sendet standardmäßig eine TCP-Anfrage an Port 111 mit einer zufälligen
Transaktions-ID (XID). Das Angriffstool sendet die Anforderung zwar an UDP-Port 111,
verwendet jedoch immer dieselbe XID.
>
![[Pasted image 20260128190926.png]]
>

>[!abstract]
>### Grundlagen und wichtige Konzepte des Routings
>
**Routing Protokolle**
>Die Routing Protokolle werden eingeteilt nach deren Einsatzzweck:
>
>**Intra** AS Routing/Interieur Gateway Routing
>- Routing Information Protocol
>- Open Shortest Path First OSPF
>
>**Inter** AS Routing / Exterieur Gateway Routing
>- Border Gateway Protocol BGP (The whole Internet)
>
>![[Pasted image 20260128192031.png]]
>
>### Routing Information Protocol (RIP)
>- RIP ist in zwei Versionen verfügbar RIPv1 und RIPv2
>
>![[Pasted image 20260129101213.png]]
>
>**Command**: 0x01 - Request, 0x02 -Response
>**Version**: 0x01
>**AFI**: 0x02 - Response
>**Metric**: Kosten der Route
>
>![[Pasted image 20260129101425.png]]
>
>Next Hop: 0.0.0.0 Sender selbst ist die beste Route, sonst IP einer besseren Route
>
>Bei ersten Kontakt AFI 0xFFFF für Authentifikation:
>
>![[Pasted image 20260129101829.png]]
>
>**Auth Type**: 0x02 - Plain, 0x03 - MD5
>
>- Authentication ist fast immer Plaintext
>- Route Tag 16 Bit, also 65536 Möglichkeiten
>- RIP Router finden:
>	- nmap -v -sU -p 520
>	- wenn im selben Subnetz - Wireshark
>	- wenn nicht: nemesis-rip (Windows, Linux)
>
>>[!danger] Angriffe auf RIP - RIPv1 Reflection DDoS
>>- Abfrage der Routing Tabelle des RIP Routers mit einem typischen Request von 24 Byte
>>- Spoofen der Absender Adresse durch der des Opfers
>>- der RIP Router sendet dann in der Response die Routing Tabelle an das Opfer, in mehreren 504 Byte großen Payload Fragmenten (max. 25 Routing Eintragungen per Payload)
>>- Angreifer nutzen zumeist RIP Router die sehr viele Routing Eintragungen enthalten (möglicherweise gefälscht und aufgebläht)
>>- ein Amplification Faktor von mehr als 22 ist damit bei nur einem Response Paket gegeben
>>
>>![[Pasted image 20260129103943.png]]
>
>### Open Shortest Path First Routing (OSPF)
>OSPF steht für Open Shortest Path First und ist das meist genutzte Routing Protokoll für Interior-Gateway Routing. Es ist robust, bietet Sicherheitsfeatures und wird von vielen Routern unterstützt
>
>OSPF an sich ist sehr Komplex, folgende wichtige Konzepte beinhaltet es aber grundlegend:
>- Neighbors: jeder Router baut eine Vertrauensbeziehung zum Nachbarrouter im selben Subnetz auf und teilt sich dessen Eigenschaften (z.B.: areaID, area type, subnet, …)
>- Hello, Advertisements und Updates: es existieren verschiedene Nachtichtentypen die die Informationen zwischen den Routern austauschen
>- Fight-Back Mechanismus: wenn ein Router ein Fake Advertisement empfängt / so sendet er ein Update seiner Informationen an die OSPF Multicast Adresse (224.0.0.5), neue Advertisements überschrieben alte Fake Advertisements.
>
>>[!danger] Angriff Fight Back
>>Im Jahr 2011 demonstrierten Kirshon, Gonikman und Dr. Nakibly während der Black Hat USA einen Angriff, der es ermöglichte, den Fight Back Mechanismus zu umgehen. Die Idee hinter dem Angriff ist recht einfach: Stellen Sie sich zwei benachbarte Router, A und B, vor. Der Angreifer generiert zwei Pakete, von denen eines an den Opfer-Router A gesendet wird, um die Abwehr auszulösen, und eines gleichzeitig an den Router B, in den die böswilligen Routen eingeschleust werden sollen. Das von A gesendete Fightback-Paket wird von B nach dem böswilligen Paket empfangen und verworfen, da es als identisch angesehen wird, auch wenn der Inhalt der beiden Pakete unterschiedlich ist.
>>
>>Der Angriff ist möglich, weil zwei OSPF-LSA-Pakete (Link State Advertisement) als identisch betrachtet werden, wenn sie Folgendes aufweisen:
>>- die gleiche Sequenznummer
>>- derselbe 16-Bit Prüfsummenwert
>>- ungefähr gleich alt (innerhalb eines Zeitunterschieds von 15 Minuten)
>>
>>Die Sequenznummer und das Alter sind leicht zu erkennen und zu fälschen, während die Prüfsumme berechnet werden muss. Glücklicherweise kann dies vorhergesagt werden, da es für LSA-Felder berechnet wird, deren Werte im Voraus abgeleitet werden können.
>>
>>![[Pasted image 20260129105854.png]]
>
>### Border Gatway Protocol Routing (BGP)
>Das Routing im Internet erfolgt über Autonome Systeme (AS) denen entsprechende IP-Adressbereiche zugeordnet werden. Je nach Subnet Mask können damit eine bestimmte Anzahl an Hosts zusammengefasst werden.
>
>Das Routing erfolgt über eine Zuordnung der Adressbereiche und der AS Pfade (AS Path) zwischen den einzelnen Routern. Zuständig dafür ist das Border Gatway Protocol BGP für die AS Außengrenzen der AS Subnetze.
>
>![[Pasted image 20260129110303.png]]
>
>Für das Internet wurden die Netzwerkklassen durch das Classless Inter-Domain Routing (CIDR) ersetzt. Die CIDR Notation wird durch ein / nach der IP Adresse dargestellt und gibt die genutzten Bit der IP-Adressebereiche wieder.
>
>![[Pasted image 20260129111035.png]]
>
>Folgende IP Adressen 192.168.2.0/24, 192.168.2.1/24, 192.168.2.2/24, ... 192.168.2.254/24 und 192.168.2.255/24 beschreiben auf Grund des 24 Bit langen Präfix, dasselbe IP-Subnetz, welches von einem Autonomen System AS als Routing Ziel angegeben werden kann.
>
>Für das BGP Routing ist es wichtig zu wissen, dass das Routing Ziele mit der gößten Spezifikation also der höchsten Bit Angabe der CIDR Präfix Notation die Route für sich gewinnen.
>
> Ein  Für das BGP Routing ist es wichtig zu wissen, dass das Routing Ziele mit der gößten Spezifikation also der höchsten Bit Angabe der CIDR Präfix Notation die Route für sich gewinnen.
> - zugewiesene ungenutzte IP-Adressbereiche
> 	- Reputations verlust des Eigentümers
> 	- Aufbau eines Hijacking Netzwerkes
> - zugewiesene ungenutzte IP-Adressbereiche
> 	- Störung von Verbindungen 
> 	- Abkapselung von Opfer Systemen
> 	- Übernahme von Verbindungen
> 
>>[!example]
>>Beispiel Youtube Februar 2008: YouTube nutzt 208.65.152.0/22 Das beinhaltet den spezifischeren Adressbereich 208.65.153.0/24. Die /24 beinhaltete alle von YouTube’s: DNS Servers & Web Servers YouTube registrierte nur den Bereich /22
>>
>>![[Pasted image 20260129112520.png]]
>>
>>-  Parkistan Telecom regestiert sich den Bereich /24
>>- In BGP gewinnt die spezifische Route!
>>- Pakistan Telecom erhält für 2 Stunden den kompletten Traffic für Youtube übermittelt.  
>>
>>![[Pasted image 20260129112913.png]]
>>
>
>Session Description Protocol SDP
>- Client und Host verhandeln über Codec für einen nachfolgenden Stream 
>- Was pasiert wenn Client vorgibt keinen Codec zu verstehen?
>	- Host schickt Liste aller Codecs die er kennt 
>
>### Das Session Initation Protocol SIP - VoIP
>SIP - Übersicht:
>- SIP ist ein Signal Protokoll, das zum Erstellen, Ändern und Beenden einer Multimedia-Sitzung über das Internet-Protokoll verwendet wird. Eine Sitzung ist nichts anderes als ein einfacher Anruf zwischen zwei Endpunkten.
>- SIP ist in RFC 3261 definiert.
>- SIP ist eine Client-Server-Architektur unter Verwendung von URL und URI aus HTTP sowie ein Textcodierungsschemata aus SMTP.
>- SIP nutzt das SDP (Session Description Protocol), das eine Sitzung mit RTP (Realtime Transport Protocol) beschreibt, für die Übertragung von Sprache und Video.
>- SIP kann für Sitzungen mit zwei Teilnehmern (Unicast) oder mehreren Teilnehmern (Multicast) verwendet werden.
>
>SIP Header: 
>
>![[Pasted image 20260129113752.png]]
>
>SIP Header - Kompakte Form
>Viele SIP Header Eintragungen  haben eine Kuzschreibweise.
>
>![[Pasted image 20260129113939.png]]
>
>Mehrstufiger Prezess:
>1. Discover 
>2. Subscripe
>3. Invite
>
>SIP Call Flow
>
>![[Pasted image 20260129114619.png]]
>
>>[!danger] SIP Amplification Attack 
>>1. SIP Server Senden Fehlernachrichten oft +10
>>2. Benutzung der Opfer IP für Soofed Packets
>>3. SIP Server senden Response zum Opfer
>>=> packet for 10+ Packets, ICMP Errors(Bonus)
> >
>>![[Pasted image 20260129114950.png]]

