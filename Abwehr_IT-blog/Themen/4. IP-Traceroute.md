[!] **Vermittlungsschicht (Network Layer)**
- Die Vermittlungsschicht (Layer 3) bildet die Grundlage für die Kommunikation über Netzwerke.
- Wichtige Protokolle:
    - **IP (Internet Protokoll):** Grundlage für die Datenübertragung.
    - **ICMP (Internet Control Message Protocol):** Diagnose- und Fehlermeldungsprotokoll.
    - **Routing-Protokolle:** RIP, OSPF, BGP (zur Wegfindung in Netzwerken).
#### **Das Internet Protokoll (IP)**
#### **Eigenschaften**
- **Verbindungslos:** Kein Zustand zwischen Sender und Empfänger.
- **eindeutiges Adressschema:** Ermöglicht eindeutige Identifikation der Geräte.
- **Fragmentierung:** Zerlegt große Datenpakete in kleinere Segmente.
- **Fehleranfälligkeiten:**
    - da Verbindungsloser  Dienst → anfällig für Spoofing und DoS-Angriffe.
#### **Vergleich IPv4 vs. IPv6**
- IPv6 entfernt die Fragmentierung, CRC-Prüfungen und Optionsfelder zur Optimierung des Routings.
- IPv6-Adressen können Rückschlüsse auf MAC-Adressen zulassen.
#### **Der IPv4-Header**
- Enthält wichtige Felder wie:
    - **IHL (Internet Header Length):** Header-Länge in 32-Bit-Words (min. 5, max. 20).
    - **TTL (Time to Live):** Maximale Anzahl an Hops (wird bei jedem Router verringert).
    - **Protokoll:** Gibt das Transportprotokoll an (z. B. 0x06 für TCP, 0x11 für UDP).
    - **Checksum:** Prüft auf Bitfehler, wird bei jedem Hop neu berechnet.

![[Pasted image 20250123085444.png]]
#### **Internet Control Message Protocol (ICMP)**
ist ein weiteres Protokoll auf dem Network Layer. Es unterscheidet
sich von vielen anderen Protokollen und Anwendungen darin, dass es
normalerweise nicht von Netzwerkanwendungen gesteuert wird.
Es wird für logische Fehler und zur Diagnose verwendet. Es kann auch
von Angreifern missbraucht werden, wie etwa für Smurf Attacken und
kann beim Port Scan hilfreich sein.

![[Pasted image 20250123090236.png]]
### **Einsatzbereiche**
- Diagnose und Fehlermeldungen im Netzwerk (z. B. Ping, Traceroute).
- Wichtige ICMP-Typen:
    - Typ 8: Echo Request.
    - Typ 0: Echo Reply.
    - Typ 3: Destination Unreachable.
    - Typ 11: Time Exceeded.
#### **Traceroute (ICMP)**
- Werkzeug zur Verfolgung von Netzwerkrouten.
![[Pasted image 20241204165943.png]]
- Funktionsweise:
	- Für jeden Hop neues UDP Paket
    - Sendet Pakete mit schrittweise erhöhter TTL.
    - Jeder Router antwortet mit **ICMP TLL Exceeded**, bis das Ziel erreicht wird (Antwort: **ICMP Port Unreachable**).
### <mark style="background: #FF5582A6;">Angriffe auf IPv4 und ICMP</mark>
**Schwächen IP**:
- verbindungslos
- keine Authentisierung
#### **IP-Spoofing**
- Fälschen der Absende Adresse eines IP Pakets:
	- **Lokales Spoofing:** Im gleichen Subnetz; nutzt Packet-Analyzer, um vertrauenswürdige IPs zu imitieren.
	- **Blind Spoofing:** Außerhalb des Subnetzes, schwierig aufgrund randomisierter Sequenznummern.
#### **Fragmentierungsangriffe**
**Ausnutzen der Fragmentierung:**
- Pakete die ein System sieht aber ein anderes nicht.
- Fehlerhafte Fragmentierung
- Ausnutzen von Schwachstellen der NIDS (Network Intrusion Detection Systeme)
#### **Insertion Attack**
- **Beschreibung:**  
    Bei einer Insertion-Attacke fügt der Angreifer Pakete ein, die vom Endpunkt ignoriert werden, aber von Intrusion Detection Systemen (IDS) als gültig interpretiert werden. Ziel ist es, die Analyse des IDS zu umgehen, während der Endpunkt die eigentlichen Daten korrekt empfängt.
- **Techniken:**
    - **Falsche Sequenznummern:** Pakete mit ungültigen Sequenznummern werden vom Endpunkt verworfen, können aber vom IDS verarbeitet werden.
    - **Falsche Prüfsummen:** IDS überprüfen TCP-Prüfsummen oft nicht, Endpunkte hingegen schon. Pakete mit falschen Prüfsummen werden ignoriert, können jedoch das IDS täuschen.
    - **Manipulierte TTL-Werte:** Pakete mit einem zu niedrigen TTL-Wert erreichen den Endpunkt nicht, werden jedoch vom IDS registriert.
- **Beispiel:**  
    Ein Angriff könnte zusätzliche Daten in ein Paket einfügen, um eine Signatur zu verschleiern:
    - IDS sieht: `GET /cgi-bin/pleasedontdetectthisforme`
    - Endpunkt empfängt: `GET /cgi-bin/phf`
#### **Evasion Attack**
- **Beschreibung:**  
    Bei Evasion-Angriffen werden Pakete so manipuliert, dass sie vom Endpunkt akzeptiert, aber vom IDS abgelehnt oder falsch interpretiert werden. Ziel ist es, die Erkennung durch das IDS zu umgehen.
- **Techniken:**
    - **Fragmentierung in falscher Reihenfolge:** Das IDS setzt Fragmente in der falschen Reihenfolge zusammen, während der Endpunkt die richtige Reihenfolge verwendet.
    - **Flutung von SYN-Paketen:** Überfluten des Zielports mit nicht existierenden SYN-Paketen, damit das IDS die echte Verbindung nicht mehr verfolgen kann.
    - **Ungewöhnliche Paketgrößen:** Versenden von Fragmenten, die das IDS nicht korrekt verarbeitet.
- **Beispiel:**  
    Das IDS erkennt nur einen Teil eines Pakets:
    - IDS sieht: `GET /gin/f`
    - Endpunkt empfängt: `GET /cgi-bin/phf`
#### **Teardrop Attack**
- **Beschreibung:**  
    Eine Teardrop-Attacke nutzt die Fragmentierung von IP-Paketen aus. Fragmente werden mit fehlerhaften oder überlappenden Offsets gesendet, sodass Systeme, die diese Pakete nicht korrekt zusammensetzen können, abstürzen.
- **Funktionsweise:**
    - Pakete mit falschen Fragmentierungsinformationen (Offsets) führen zu Konflikten beim Zusammensetzen.
    - Einige Systeme reagieren darauf mit Abstürzen oder hängen sich auf (z. B. ältere Versionen von Windows oder Linux).
- **Ziele:**
    - **Denial of Service (DoS):** Systeme wie Windows 95, NT oder Linux 2.1.63 können durch überlappende Fragmente überlastet und zum Absturz gebracht werden.
    - **Verwirrung von IDS:** Überlappende Fragmente können dazu führen, dass IDS und Endpunkte unterschiedliche Pakete zusammensetzen.
- **Beispiel:**  
    Fragmente wie:
    - Fragment 1: `GET /cgi-bin/ph`
    - Fragment 2: `bin/phf`
    - Ergebnis beim IDS: `GET /cgi-bin/phbin/phf`
    - Ergebnis beim Endpunkt: `GET /cgi-bin/phf`
#### **Schutzmaßnahmen gegen diese Angriffe**
1. **Insertion Attack:**
    - IDS mit **Prüfsummenvalidierung** und **Sequenznummerprüfung** einsetzen.
    - Paketfilter konfigurieren, die ungültige Pakete ablehnen.
2. **Evasion Attack:**
    - IDS aktualisieren, um auch ungewöhnliche Fragmentierungs- und Sequenzierungsverhalten zu erkennen.
    - Netzwerküberwachung auf ungewöhnliche Paketgrößen und Fragmentierungsarten.
3. **Teardrop Attack:**
    - Aktualisierung des Betriebssystems und der Netzwerktreiber.
    - Verwendung moderner Systeme, die fehlerhafte oder überlappende Fragmente korrekt behandeln.
    - Einsatz von Firewalls, die überlappende Fragmente ablehnen.
#### **ICMP-Angriffe**
- **Smurf Attack(ICMP Echo Attacks):** Missbraucht ICMP Broadcasts, um Opfer mit Antworten zu überfluten. Gefälschter Absender, Opfer als Ziel erzeugen und als Brodcast absetzen. Gepingte Server Antworten alle dem Opfer -> DDoS
- **ICMP Nukes:** Gefälschte „Destination Unreachable“-Nachrichten, um Verbindungen zu trennen.
- **ICMP Redirect Angriff:** Schicke gefälschte ICMP Nachricht an ein Opfer mit einer ICMP Redirect Nachricht um den Netzwerkverkehr des Opfers über ein kompromittiertes System umzulenken.
- **Covert Channels:** Nutzung von ICMP-Paketen zum Übertragen verdeckter Nachrichten.
- **Ping of Death:** Ping max 64K Daten -> Fragmentierung mehr als 64K -> Buffer Overflow
- **Land Angriff:** (DoS) Angreifer -> SYN bei dem Quell und Zieladresse sowie -Port identisch sind, an offenen Port von Opfer, dieser antwortet mit SYN-ACK an Quelle, also sich selbst. -> Endlosschleife 
#### **Schutzmaßnahmen**
- **Firewall-Regeln:** Blockieren gefälschter IP-Adressen und unerwünschter ICMP-Nachrichten.
- **IPSec:** Verschlüsselt Datenpakete zur Sicherung der Kommunikation.
- **Routing-Protokolle:** Nicht benötigte Protokolle deaktivieren.
- **Paketfilter:** Zur gezielten Filterung von ICMP-Nachrichten an Netzwerkgrenzen. 
#### **Zusammenfassung**
- Das IP-Protokoll bietet die Grundlage für weltweite Kommunikation, ist jedoch anfällig für Spoofing und DoS-Angriffe.
- ICMP ist sowohl für Diagnosen als auch für Angriffe geeignet (z. B. Smurf Attack, Ping of Death).
- IPv6 bietet größere Sicherheit und Effizienz, ist aber nicht vollständig gegen Angriffe immun.